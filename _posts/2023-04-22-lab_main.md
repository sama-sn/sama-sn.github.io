---
title: Virtual enterprise network intro
categories: [homelab, main]
tags: [homelab,main]     # TAG names should always be lowercase
pin: true
---
(Working on it - April 22, 2023. May add docker containers)
Index:
[Presentation day]
--Normal index--
Todo:
- [ ] All linked pages should start and end with links to [next], [previous] and [home] pages ==use the page names instead of the "next"==
- [ ] Troubleshooting or Misc page
## Project overview:
### Intro:
This project aims to provide a manual/guide to creating a home lab. This home lab helps one to create an enterprise network on a server. You can simulate attacks, check how the firewall/IDS works, understand the logs and network traffic, and learn more from it. These instructions are provided based on what I could take away from Jeff McJunkin's [kickass home lab](http://bit.ly/kickasslab) ==SANS youtube==

### [The `refresher` mode:](/posts/quick_version)
1. Gain root on metasploitable2
2. Setup an authoritative DNS server
3. DNS based attacks
	1. Data exfiltration
	2. C2 using dnscat2
4. Setup Active Directory.

### How?
Using an example. It contains:
- Details on how to set up the network with a web server.
- An example attack scenario that involves privilege escalation, and persistence (`dnscat2`)
- Instructions on how to:
	- Collect the network traffic (`pfsense` packet capture)
	- Setup Active Directory
### My favorite parts:
1. Setting up your own Authoritative DNS server for DNS based c2 using dnscat2
2. Active Directory setup
3. Port-forwarding setup on `PfSense` and `VyOS` router
### How did this help me:
1. I wanted to see how the network traffic looks like during a DNS based c2. Good thing I had a lab setup, I was able to understand that in an instant. 
2. Now, because it is on a level2 hypervisor - VMware workstation pro, I can copy the `pcap` files to my host OS, share, teach, train, and get feedback faster.
### What I found challenging:
1. Setting up the `PfSense` - firewall rules, DNS, port-forwarding clashes with VMware.
2. Authoritative DNS server - DNS propagation and TTL.
### Eye-openers:
1. Snapshots ~ Time travel.(Dormamu, I've co...)
2. For DNS, set low TTL values till things work out. 
3. After you know how to setup `pfsense`, you wonder how you struggled with such a simple and elegant software
### Possible use cases:
- Perform an attack -> export the network dump (`pcap` files) -> train employees to find the exploited vulnerabilities
- A quick[^1] and safe environment for trying firewall rules, exploitation techniques, and tools.
- You can create vulnerable systems, share them, grow as a group, perform pen-test or red team scenarios, and make reports.
- Perform forensics on exploited machines
### What one can get from this manual:
- I made a bunch of mistakes, and you can avoid them
- Links and references that helped me understand the topics

## Home lab summary:

### Example network:
![Home Lab Network Diagram](/assets/img/home_lab_nw.png)

### Phase1 - Setup and initial access summary:
#### Network - VMWare configuration:
- Make a NAT network (`192.168.189.0/24`). This shall be the WAN network for the PfSense firewall. [HowTo VMware configuration](/posts/vmware_configuration)
- Make a host-only network (`10.10.20.0/24`). This acts as the LAN network on Pfsense. (DHCP is enabled, but we assign static addresses)
- Make another host-only network (`10.10.10.0/24`) -DMZ network (configured as OPT1 on Pfsense) with the metasploitable2 machine. The metaspoloitable2 machine has a connection to the LAN network but is currently offline.
	- Port forward the default metasploitable2's website to the WAN port 8080.
- Create one more host-only network (`18.0.0.0/24`) for the attacker. Install the VyOS router with the same gateway (`192.168.189.2/24`) as the PfSense WAN network.
	- This is an extra step that can help you simulate your scenario or to make it a bit more realistic/challenging.
	- Enable port-forwarding on the attacker's router (VyOS router - port 80, 443) for the reverse shells. 

![VMware Network Settings](/assets/img/vmware_nw.png){: width="60%"}

##### VMWare NAT (WAN) settings:
![VMware NAT settings](/assets/img/vmware_NAT_info.png){: width="80%"} 
![VMWare DNS settings](/assets/img/vmware_DNS_info.png){: width="80%"}

#### Pfsense configuration:
- Install and configure the pfsense networks. [Pfsense configuration](/posts/pfsense_configuration)
- The three networks shall be configured as mentioned above.
	- You can identify the networks based on the MAC address of the interface (vmware > settings)
	  ![VMWare MAC address information](/assets/img/pfsense_vmware_settings_mac.png){: width = "40%"}
	  - WAN's default gateway shall be `192.168.189.2` and I chose not to use IPv6.
	  - Enable DHCP on LAN and OPT1(DMZ) networks. I chose a range of (`x.x.x.128` to `x.x.x.192`) for this. 
- Set the interface addresses: (`/24` networks)
	- WAN: `192.168.189.254`
	- LAN: `10.10.20.254`
	- OPT1(DMZ): `10.10.10.254`
- Other settings
- [ ] Name the settigs and path (General setup) in a seperate link.
- [ ] This page should contain summarized steps. Example: Add static addresses to systems from status>DHCP leases.
##### Network configuration- Pfsense:
- Static IP assignment
#### Pfsense Firewall Rules:

#### Setup port-forwarding on pfsense:
- Problems caused by the clash between vmware NAT, DHCP, and port-forwarding rules
- remove vmware dhcp
#### packet capture:
cmd or web configurator
### VMware networks:
- If you know how to setup networks on vmware, just disable DHCP ==be specific==
- Else, my vmware setup vid: //link (do not display)
### VyOS setup: (at the end)
- ==Check if you can export the configuration settings== => If yes, do curl or wget
- [NAT â€” VyOS 1.3.x (equuleus) documentation](https://docs.vyos.io/en/equuleus/configuration/nat/index.html)
- [VyOS Community](https://vyos.net/get/) (select legacy > ==ova for vmware==)
#### Port-forwarding:
- For reverse shells

#### Attack scenario:
- Recon the WAN network `192.168.189.0/24` using `nmap` (Disable host discover `-Pn`). You'll find the firewall address
- Scan the firewall IP address, and you may find the open port for the website. Learn more by using `nmap` or other tools like Nesus.
- `searchsploit` or `exploit.db` for payloads. Exploit the system, gain user access, and point the reverse shell to the VyOS router address port 80
- Escalate privileges, and gain root access through another reverse shell. Use port 443 of the same router.
- Check the current network interfaces. You will find an offline interface.
- Bring up the interface. It connects to the LAN network.
- Scan the internal (LAN) network using `nmap`, find vulnerable systems, move laterally, and learn more about the enterprise.
#### Forensics:
- Use the `pcap` file from the packet capture. Learn what vulnerabilities the attacker used for exploitation.
- Also, you can perform memory analysis using `vmem` files (you can see them when you take a snapshot of the machine). These files can help if you consider a scenario where the SOC team finds abnormal activity and takes a memory dump of that system.

### Phase2 - DNS attacks summary:

## Detailed steps:
[Helpful links]
VMware network export: [Exporting Network Settings (vmware.com)](https://docs.vmware.com/en/VMware-Workstation-Pro/17/com.vmware.ws.using.doc/GUID-8563548D-5FD7-4D78-AFAF-4A28E4EA48BD.html)

### Active Directory Setup:
//link


## ==Note==
1. Use LAN segments if you are dealing with malware analysis. You may need to follow additional steps to isolate the machine.
My takeaway:
- I believe that something like this could've been useful for my past self to understand basic concepts of networking and penetration testing. So, I'm sure it can help someone who wants to learn or teach.
- Looks too simple or basic? Good, that was the point. Can you do better? That is the expected outcome. If you can understand and follow along, you can make and test better scenarios.

## References:


[^1]: This is faster to set up when compared to working with a level 1 hypervisor.
